name: verilator-test
on:
  push:
    branches:
      - '5-stages-pipeline'

jobs:
  ubuntu-18-functional-test:
    runs-on: ubuntu-18.04
    steps:
      - name: Checkout -dev repository
        uses: actions/checkout@v2.3.4
        with:
          ref: 5-stages-pipeline
      - name: Install prerequisites
        run: |
          sudo apt install -y gtkwave make clang-10 libc++-10-dev libc++abi-10-dev libz-dev
          wget -O verilator4.deb https://github.com/sifive/verilator/releases/download/4.036-0sifive2/verilator_4.036-0sifive2_amd64.deb
          sudo dpkg -i verilator4.deb
          sudo ln -s /usr/local/share/verilator /usr/share/
      - name: Run NSCSCC functional tests
        run: |
          git clone https://github.com/FDUCSLG/ICS-2021Spring-FDU.git
          cd ICS-2021Spring-FDU
          rm -r source/include source/mycpu
          cp -r ../5-stages-pipeline/source/include ./source
          cp -r ../5-stages-pipeline/source/mycpu ./source
          make vsim -j USE_CLANG=1 VSIM_OPT=1 TARGET=mycpu/VTop VSIM_ARGS='--no-status'

  ubuntu-18-functional-test1-4:
    runs-on: ubuntu-18.04
    steps:
      - name: Checkout -dev repository
        uses: actions/checkout@v2.3.4
        with:
          ref: 5-stages-pipeline
      - name: Install prerequisites
        run: |
          sudo apt install -y gtkwave make clang-10 libc++-10-dev libc++abi-10-dev libz-dev
          wget -O verilator4.deb https://github.com/sifive/verilator/releases/download/4.036-0sifive2/verilator_4.036-0sifive2_amd64.deb
          sudo dpkg -i verilator4.deb
          sudo ln -s /usr/local/share/verilator /usr/share/
      - name: Run NSCSCC functional tests
        run: |
          git clone https://github.com/FDUCSLG/ICS-2021Spring-FDU.git
          cd ICS-2021Spring-FDU
          rm -r source/include source/mycpu
          cp -r ../5-stages-pipeline/source/include ./source
          cp -r ../5-stages-pipeline/source/mycpu ./source
          #make vsim -j USE_CLANG=1 VSIM_OPT=1 TARGET=mycpu/VTop TEST=test1
          #make vsim -j USE_CLANG=1 VSIM_OPT=1 TARGET=mycpu/VTop TEST=test2
          #make vsim -j USE_CLANG=1 VSIM_OPT=1 TARGET=mycpu/VTop TEST=test3
          make vsim -j USE_CLANG=1 VSIM_OPT=1 TARGET=mycpu/VTop TEST=test4

  ubuntu-18-performance-test:
    runs-on: ubuntu-18.04
    steps:
      - name: Checkout -dev repository
        uses: actions/checkout@v2.3.4
        with:
          ref: 5-stages-pipeline
      - name: Install prerequisites
        run: |
          sudo apt install -y gtkwave make clang-10 libc++-10-dev libc++abi-10-dev libz-dev
          wget -O verilator4.deb https://github.com/sifive/verilator/releases/download/4.036-0sifive2/verilator_4.036-0sifive2_amd64.deb
          sudo dpkg -i verilator4.deb
          sudo ln -s /usr/local/share/verilator /usr/share/
      - name: Run NSCSCC performance tests
        run: |
          git clone https://github.com/FDUCSLG/ICS-2021Spring-FDU.git
          cd ICS-2021Spring-FDU
          rm -r source/include source/mycpu
          cp -r ../5-stages-pipeline/source/include ./source
          cp -r ../5-stages-pipeline/source/mycpu ./source
          make vsim -j USE_CLANG=1 VSIM_OPT=1 TEST=coremark TARGET=mycpu/VTop VSIM_ARGS='--no-status'
